<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NIRS Ontology Tree with Annotations in Modal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; overflow: hidden; }
    #tree-container { width: 100vw; height: 100vh; overflow: visible; }
    svg { width: 100%; height: 100%; overflow: visible; }
    .node circle { fill: #999; stroke: steelblue; stroke-width: 1.5px; cursor: pointer; }
    .node text { font: 12px sans-serif; cursor: pointer; }
    .link { fill: none; stroke: #555; stroke-opacity: 0.4; stroke-width: 1.5px; }
    .modal {
      display: none;
      position: absolute;
      z-index: 999;
      background-color: #fefefe;
      padding: 10px;
      border: 1px solid #888;
      border-radius: 6px;
      width: 250px;
      font-size: 12px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
      cursor: move;
      word-wrap: break-word;
      word-break: break-word;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    .modal-header strong {
      font-size: 12px;
    }
    .close {
      color: #aaa;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover { color: black; }
    a { color: #0645ad; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="tree-container">
    <svg></svg>
  </div>

  <!-- Floating modal -->
  <div id="infoModal" class="modal">
    <div class="modal-header">
      <strong id="modalTitle"></strong>
      <span class="close">&times;</span>
    </div>
    <div id="modalContent"></div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    fetch('NIRS_Class_Hierarchy_with_Annotations.json')
      .then(response => response.json())
      .then(data => {
        const svg = d3.select("svg"),
              g = svg.append("g").attr("transform", "translate(40,0)");

        const zoom = d3.zoom()
          .scaleExtent([0.2, 3])
          .on("zoom", (event) => g.attr("transform", event.transform));
        svg.call(zoom);

        const tree = d3.tree().size([window.innerHeight, window.innerWidth - 160]);
        let i = 0;
        const root = d3.hierarchy(data);
        root.x0 = window.innerHeight / 2;
        root.y0 = 0;

        function collapse(d) {
          if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
          }
        }
        root.children && root.children.forEach(collapse);
        update(root);

        function update(source) {
          const treeData = tree(root);
          const nodes = treeData.descendants();
          const links = treeData.links();

          nodes.forEach(d => d.y = d.depth * 180);

          const node = g.selectAll(".node").data(nodes, d => d.id || (d.id = ++i));

          const nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${source.y0},${source.x0})`);

          nodeEnter.append("circle")
            .attr("r", 1e-6)
            .style("fill", d => d._children ? "#003366" : "#999")
            .on("click", (event, d) => {
              d.children = d.children ? null : d._children;
              update(d);
            });

          nodeEnter.append("text")
            .attr("dy", ".35em")
            .attr("x", d => d._children ? -10 : 10)
            .attr("text-anchor", d => d._children ? "end" : "start")
            .text(d => d.data.name)
            .on("click", (event, d) => {
              showModal(d.data, event.pageX, event.pageY);
              event.stopPropagation();
            });

          const nodeUpdate = nodeEnter.merge(node);
          nodeUpdate.transition()
            .duration(750)
            .attr("transform", d => `translate(${d.y},${d.x})`);
          nodeUpdate.select("circle")
            .attr("r", 6)
            .style("fill", d => d._children ? "#003366" : "#999");

          node.exit().transition()
            .duration(750)
            .attr("transform", d => `translate(${source.y},${source.x})`)
            .remove()
            .select("circle").attr("r", 1e-6);

          const link = g.selectAll(".link").data(links, d => d.target.id);
          link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", d => {
              const o = { x: source.x0, y: source.y0 };
              return diagonal(o, o);
            }).merge(link)
            .transition()
            .duration(750)
            .attr("d", d => diagonal(d.source, d.target));

          link.exit().transition()
            .duration(750)
            .attr("d", d => {
              const o = { x: source.x, y: source.y };
              return diagonal(o, o);
            })
            .remove();

          nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
        }

        function diagonal(s, d) {
          return `M${s.y},${s.x}C${(s.y + d.y)/2},${s.x} ${(s.y + d.y)/2},${d.x} ${d.y},${d.x}`;
        }

        function showModal(data, x, y) {
          const modal = document.getElementById("infoModal");
          const title = document.getElementById("modalTitle");
          const content = document.getElementById("modalContent");

          title.textContent = data.label || data.name;
          let html = data.description ? `<div style="margin-bottom:8px">${data.description}</div>` : `<div style="margin-bottom:8px"><em>No Annotations Available.</em></div>`;
          html += data.code ? `<div style="margin-bottom:8px"><strong>Mapped Ontology:</strong> ${data.code}</div>` : "";
          if (data.seeAlso) {
            html += `<div><strong>See Also:</strong> <a href="${data.seeAlso}" target="_blank" style="word-break:break-word">${data.seeAlso}</a></div>`;
          }
          content.innerHTML = html;

          modal.style.left = `${x + 20}px`;
          modal.style.top = `${y - 50}px`;
          modal.style.display = "block";
        }
      })
      .catch(error => console.error('Error loading JSON:', error));

    const modal = document.getElementById("infoModal");
    const span = document.getElementsByClassName("close")[0];
    span.onclick = () => { modal.style.display = "none"; }
    window.onclick = event => {
      if (event.target == modal) modal.style.display = "none";
    }

    let isDragging = false, offsetX, offsetY;
    modal.addEventListener('mousedown', e => {
      isDragging = true;
      offsetX = e.offsetX;
      offsetY = e.offsetY;
    });
    document.addEventListener('mousemove', e => {
      if (isDragging) {
        modal.style.left = `${e.pageX - offsetX}px`;
        modal.style.top = `${e.pageY - offsetY}px`;
      }
    });
    document.addEventListener('mouseup', () => { isDragging = false; });
  </script>
</body>
</html>
